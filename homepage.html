<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniTrello - Homepage</title>
    <link rel="stylesheet" href="homepage.css">
</head>
<body>
    <div class="app-shell">
        <header>
            <div class="brand">
                <div class="brand-icon">M</div>
                <div>
                    <h1>MiniTrello</h1>
                    <div class="brand-sub">Tablero ligero para organizar tareas por columnas</div>
                </div>
            </div>
            <div class="controls">
                <div id="userStatus" class="pill">Sesi√≥n activa</div>
                <button id="logoutBtn" class="logout">
                    <span>‚¨Ö</span> Cerrar sesi√≥n
                </button>
            </div>
        </header>

        <main class="board-wrap">
            <div class="top-row">
                <div class="top-info">
                    Escribe una tarea y agr√©gala. Luego arr√°strala entre columnas para cambiar su estado.
                </div>
                <form id="addForm" class="add-form" onsubmit="return false;">
                    <input id="taskInput" placeholder="Nueva tarea... (Enter o bot√≥n +)" autocomplete="off">
                    <button id="addBtn" title="Agregar tarea">+</button>
                </form>
            </div>

            <div class="board">
                <div class="column" data-status="pendiente">
                    <div class="col-header">
                        <div class="col-title">
                            <span class="col-tag pendiente"></span>
                            Pendiente
                        </div>
                        <div class="count" id="count-pendiente">0</div>
                    </div>
                    <div class="task-list" id="list-pendiente"></div>
                </div>

                <div class="column" data-status="enproceso">
                    <div class="col-header">
                        <div class="col-title">
                            <span class="col-tag enproceso"></span>
                            En proceso
                        </div>
                        <div class="count" id="count-enproceso">0</div>
                    </div>
                    <div class="task-list" id="list-enproceso"></div>
                </div>

                <div class="column" data-status="completo">
                    <div class="col-header">
                        <div class="col-title">
                            <span class="col-tag completo"></span>
                            Completo
                        </div>
                        <div class="count" id="count-completo">0</div>
                    </div>
                    <div class="task-list" id="list-completo"></div>
                </div>
            </div>
        </main>

        <div class="footer">
            Arrastra las tarjetas entre columnas. Los cambios se guardan localmente en este navegador.
        </div>
    </div>

    <!-- Modal para agregar tarea avanzada -->
    <div id="taskModal" class="modal hidden" aria-hidden="true" role="dialog" aria-label="Agregar tarea">
        <div class="modal-content">
            <h3>Nueva tarea</h3>
            <form id="taskForm">
                <label>
                    Nombre de la tarea
                    <input id="m_title" type="text" required maxlength="100" placeholder="Ej: Preparar informe">
                </label>
                <div class="row">
                    <label>
                        Fecha m√≠nima
                        <input id="m_start" type="date">
                    </label>
                    <label>
                        Fecha m√°xima
                        <input id="m_end" type="date">
                    </label>
                </div>
                <label>
                    Asignado a
                    <input id="m_assignee" type="text" maxlength="50" placeholder="Ej: Ana P√©rez">
                </label>
                <label>
                    Comentarios
                    <textarea id="m_comments" rows="3" maxlength="300" placeholder="Notas, detalles, requisitos..."></textarea>
                </label>
                <p id="m_error" class="error"></p>
                <div class="actions">
                    <button type="button" id="m_cancel">Cancelar</button>
                    <button type="submit" id="m_save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Sesi√≥n ---
        const logoutBtn = document.getElementById('logoutBtn');
        if (!sessionStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function () {
                sessionStorage.removeItem('loggedIn');
                window.location.href = 'index.html';
            });
        }

        // --- MiniTrello logic ---
        const STORAGE_KEY = 'minitrello_tasks_v1';
        let tasks = [];

        const input = document.getElementById('taskInput');
        const addBtn = document.getElementById('addBtn');
        const lists = {
            pendiente: document.getElementById('list-pendiente'),
            enproceso: document.getElementById('list-enproceso'),
            completo: document.getElementById('list-completo')
        };
        const counters = {
            pendiente: document.getElementById('count-pendiente'),
            enproceso: document.getElementById('count-enproceso'),
            completo: document.getElementById('count-completo')
        };

        function loadTasks(){
            try{
                const raw = localStorage.getItem(STORAGE_KEY);
                tasks = raw ? JSON.parse(raw) : [];
            }catch(e){
                tasks = [];
            }
        }
        function saveTasks(){
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        }

        function createCard(task){
            const el = document.createElement('div');
            el.className = 'task';
            el.draggable = true;
            el.dataset.id = task.id;

            el.innerHTML = `
                <div class="title">${escapeHtml(task.title)}</div>
                <div class="submeta">
                    ${task.assignee ? `<span class="chip">üë§ ${escapeHtml(task.assignee)}</span>` : ''}
                    ${(task.startDate || task.endDate) ? `<span class="chip">üìÖ ${escapeHtml(task.startDate || '')}${task.endDate ? ' ‚Üí ' + escapeHtml(task.endDate) : ''}</span>` : ''}
                </div>
                <div class="meta">
                    <button class="view" title="Ver comentarios">üí¨</button>
                    <button class="edit" title="Editar">‚úèÔ∏è</button>
                    <button class="del" title="Eliminar">üóëÔ∏è</button>
                </div>
            `;

            el.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', task.id);
                el.classList.add('dragging');
            });
            el.addEventListener('dragend', () => {
                el.classList.remove('dragging');
            });

            el.querySelector('.view').addEventListener('click', () => {
                const comments = task.comments || '';
                alert(comments ? comments : 'Sin comentarios.');
            });

            el.querySelector('.edit').addEventListener('click', () => {
                openModal(task);
            });

            el.querySelector('.del').addEventListener('click', () => {
                if (confirm('¬øEliminar tarea?')) removeTask(task.id);
            });

            return el;
        }

        function render(){
            Object.values(lists).forEach(l => l.innerHTML = '');
            const grouped = {pendiente:0,enproceso:0,completo:0};
            tasks.forEach(t => {
                const status = t.status || 'pendiente';
                const card = createCard(t);
                lists[status].appendChild(card);
                grouped[status]++;
            });
            counters.pendiente.textContent = grouped.pendiente;
            counters.enproceso.textContent = grouped.enproceso;
            counters.completo.textContent = grouped.completo;

            document.querySelectorAll('.column').forEach(col => {
                col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('dragover'); });
                col.addEventListener('dragleave', () => { col.classList.remove('dragover'); });
                col.addEventListener('drop', e => {
                    e.preventDefault();
                    col.classList.remove('dragover');
                    const id = e.dataTransfer.getData('text/plain');
                    const status = col.dataset.status;
                    moveTaskTo(id, status);
                });
            });

            Object.keys(lists).forEach(k => {
                if (lists[k].children.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty';
                    empty.textContent = (k === 'pendiente'
                        ? 'No hay tareas pendientes'
                        : k === 'enproceso'
                            ? 'Nada en proceso'
                            : 'Nada completo');
                    lists[k].appendChild(empty);
                }
            });
        }

        function addTaskFromModal(data){
            const id = 't_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
            const task = {
                id,
                title: data.title,
                status: 'pendiente',
                startDate: data.startDate || '',
                endDate: data.endDate || '',
                assignee: data.assignee || '',
                comments: data.comments || ''
            };
            tasks.unshift(task);
            saveTasks();
            render();
        }

        function removeTask(id){
            tasks = tasks.filter(x => x.id !== id);
            saveTasks();
            render();
        }

        function moveTaskTo(id, status){
            const t = tasks.find(x => x.id === id);
            if (!t) return;
            t.status = status;
            saveTasks();
            render();
        }

        function escapeHtml(str){
            return str
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'",'&#39;');
        }

        // Modal logic
        const modal = document.getElementById('taskModal');
        const taskForm = document.getElementById('taskForm');
        const mTitle = document.getElementById('m_title');
        const mStart = document.getElementById('m_start');
        const mEnd = document.getElementById('m_end');
        const mAssignee = document.getElementById('m_assignee');
        const mComments = document.getElementById('m_comments');
        const mError = document.getElementById('m_error');
        const mCancel = document.getElementById('m_cancel');

        function openModal(existing){
            modal.classList.remove('hidden');
            modal.setAttribute('aria-hidden', 'false');
            mError.textContent = '';
            if (existing){
                mTitle.value = existing.title || '';
                mStart.value = existing.startDate || '';
                mEnd.value = existing.endDate || '';
                mAssignee.value = existing.assignee || '';
                mComments.value = existing.comments || '';
                taskForm.dataset.editId = existing.id;
            } else {
                mTitle.value = input.value.trim();
                mStart.value = '';
                mEnd.value = '';
                mAssignee.value = '';
                mComments.value = '';
                delete taskForm.dataset.editId;
            }
            mTitle.focus();
        }
        function closeModal(){
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
        }

        addBtn.addEventListener('click', () => openModal());
        document.getElementById('addForm').addEventListener('submit', (e) => {
            e.preventDefault();
            openModal();
        });
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                openModal();
            }
        });

        mCancel.addEventListener('click', () => closeModal());
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // Simple validation
            const title = mTitle.value.trim();
            const startDate = mStart.value || '';
            const endDate = mEnd.value || '';
            const assignee = mAssignee.value.trim();
            const comments = mComments.value.trim();
            if (!title){
                mError.textContent = 'El nombre de la tarea es obligatorio.';
                mTitle.focus();
                return;
            }
            if (startDate && endDate && startDate > endDate){
                mError.textContent = 'La fecha m√≠nima no puede ser mayor que la m√°xima.';
                mStart.focus();
                return;
            }

            const editId = taskForm.dataset.editId;
            if (editId){
                const t = tasks.find(x => x.id === editId);
                if (t){
                    t.title = title;
                    t.startDate = startDate;
                    t.endDate = endDate;
                    t.assignee = assignee;
                    t.comments = comments;
                    saveTasks();
                    render();
                }
            } else {
                addTaskFromModal({ title, startDate, endDate, assignee, comments });
            }
            closeModal();
            input.value = '';
            input.focus();
        });

        loadTasks();
        render();
    </script>
</body>
</html>